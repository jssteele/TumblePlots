---
title: "Modified Interaction Plots for GSS Data"
author: "Todd E Bodner, PhD & Joel S Steele, PhD"
date: "December 20, 2016"
output: pdf_document
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(comment='')
```

# Graphs of modified interaction plots for the GSS data set

```{r}
library(foreign)
data <- read.spss("gssspssreduced.sav", to.data.frame=TRUE)

tumble_set = function(dat, outcome, target, moderator) {
  form = as.formula(paste(outcome,'~',target,"*",moderator))
  intrxn_mod = lm(form,data=dat)
  return(
    list('full_mod'=intrxn_mod,
       'outcome'=outcome,
       'target'=target,
       'moderator'=moderator,
       'dataset'=dat)
  )
}

GSS_tumble = tumble_set(data, 'prestg80','educ','maeduc')

# ABSTRACT OUT
#outcome
# DV = data$prestg80
# # target predictor
# tarpred = data$educ
# # moderation predictor
# modpred = data$maeduc
# educ = data$educ
# maeduc = data$maeduc

```

## Moderated regression

As a first step we fit the full moderated model.

```{r}

#Step 1
# ABSTRACT OUT
# mmr <- lm(DV ~ tarpred + modpred + tarpred*modpred)
# 
# kable(summary(mmr)$coefficients, digit=c(3,3,3,4), caption='Moderation Model')
```

Next we create a new value of $M \pm SD$ for the moderator. 

```{r}
#Step 2
# store the standard variance
# ABSTRACT OUT
modvar = var(modpred)
lowmod <- mean(modpred)-sqrt(modvar)
highmod <- mean(modpred)+sqrt(modvar)

mod_set = function(tumble){
  mod_sd = sd(tumble$dataset[,tumble$moderator])
  mod_mu = mean(tumble$dataset[,tumble$moderator])
  mod_low = mean(modpred)-modvar
  mod_high = mean(modpred)+modvar

}

```

Next we regress the target predictor onto the moderator. From here we predict the new outcomes based on the high and low values for the moderator that we constructed above.

```{r}
#Step 3
# ABSTRACT OUT
reg <- lm(tarpred ~ modpred)
predst3 <- summary.lm(reg)
tmlm <- predst3$coeff[1,1] + predst3$coeff[2,1]*lowmod
tmhm <- predst3$coeff[1,1] + predst3$coeff[2,1]*highmod

# prediction based on the model
# ABSTRACT OUT
modpredvals = predict(reg, data.frame('modpred'=c(lowmod,highmod)))
# display
kable(cbind('+/- 1 SD'=c(lowmod,highmod),
            'Predictions'=modpredvals, 
            'Direct'=c(tmlm,tmhm)), 
      digits=4, caption='Moderation values and predictions')
```

To these predicted values we add the standard residual value from the regression involving the predictors.

```{r}
#Step 4
# residual variance or error of fit.
# ABSTRACT OUT
tresid = summary(reg)$sigma#^2
hthm <- tmhm+tresid
lthm <- tmhm-tresid
htlm <- tmlm+tresid
ltlm <- tmlm-tresid

# ABSTRACT OUT
tarmodvals = c(rep(modpredvals,each=2) + rep(c(-1,1)*tresid,times=2))
names(tarmodvals)=c("ltlm","htlm","lthm","hthm")

# quick comparison
kable(cbind('crossprod'=tarmodvals, 
            'direct'=c(ltlm,htlm,lthm,hthm)), 
      digits=4, caption='Comparison of alternative computations')
```

Returning to the full moderated regression model we use these new computed values to create the endpoints of our eventual graphs.

```{r}
#Step 5
# new attempt using the data from before along with the model
# ABSTRACT OUT
newdat = data.frame('tarpred'=tarmodvals, 'modpred'=c(lowmod,lowmod,highmod,highmod))
build_dat = cbind(newdat, 'target'=rep(c('low','high'),times=2), 'moderator'=rep(c('low','high'),each=2))

# ABSTRACT OUT
newdat$"tarpred:modpred" = with(newdat, tarpred*modpred)
predhr <- summary.lm(mmr)

hhhr <- predhr$coeff[1,1] + predhr$coeff[2,1]*hthm + 
   predhr$coeff[3,1]*highmod + predhr$coeff[4,1]*hthm*highmod

hlhr <- predhr$coeff[1,1] + predhr$coeff[2,1]*htlm + 
   predhr$coeff[3,1]*lowmod + predhr$coeff[4,1]*htlm*lowmod

lhhr <- predhr$coeff[1,1] + predhr$coeff[2,1]*lthm + 
   predhr$coeff[3,1]*highmod + predhr$coeff[4,1]*lthm*highmod

llhr <- predhr$coeff[1,1] + predhr$coeff[2,1]*ltlm + 
   predhr$coeff[3,1]*lowmod + predhr$coeff[4,1]*ltlm*lowmod

predicted_values = c(llhr,hlhr,lhhr,hhhr)
# ABSTRACT OUT
newdatout = predict(mmr, newdat)
# update our built data frame
build_dat = cbind(build_dat, newdatout)

```

## Plotting set-up

Original Tumble-Plot
```{r, echo=TRUE}
#Step 6
prep <- t(matrix(c(hthm,hhhr,htlm,hlhr,lthm,lhhr,ltlm,llhr),2,4))
plot(prep[,1],prep[,2],ann=FALSE, ylim=c(20,65),xlim=c(5,22))
segments(hthm,hhhr,lthm,lhhr)
segments(htlm,hlhr,ltlm,llhr,lty="dashed")
mtext("Respondent's Years of Education", side=1, line=2.5, cex=1)
mtext("Predicted Occupational Prestige", side=2, line=2.5, cex=1)
legend(6,55,c("14.2 Years (1 SD Above Mean)","7.3 Years (1 SD Below Mean)"),cex=.8, 
  lty=c("solid","dashed"), title="Mother's Years of Education")
```

Abstracted out code.

```{r, echo=TRUE}
plot(NA, xlim=range(build_dat$tarpred), ylim=range(build_dat$newdatout), ann=FALSE)
with(build_dat[build_dat$moderator=='high',], lines(newdatout ~ tarpred, type='o'))
with(build_dat[build_dat$moderator!='high',], lines(newdatout ~ tarpred, type='o', lty='dashed'))
mtext("Respondent's Years of Education", side=1, line=2.5, cex=1)
mtext("Predicted Occupational Prestige", side=2, line=2.5, cex=1)
legend("topleft",c("14.2 Years (1 SD Above Mean)","7.3 Years (1 SD Below Mean)"),cex=.8, 
  lty=c("solid","dashed"), title="Mother's Years of Education", bty='n',inset=.01)

```
   
   
## Standard interaction Graph

Need to update this to match the format from above.

```{r}
mtar <- mean(tarpred)
sdtar <- sqrt(var(tarpred))
htar <- mtar + sdtar
ltar <- mtar - sdtar
shhhr <- predhr$coeff[1,1] + predhr$coeff[2,1]*htar + 
   predhr$coeff[3,1]*highmod + predhr$coeff[4,1]*htar*highmod
shlhr <- predhr$coeff[1,1] + predhr$coeff[2,1]*htar + 
   predhr$coeff[3,1]*lowmod + predhr$coeff[4,1]*htar*lowmod
slhhr <- predhr$coeff[1,1] + predhr$coeff[2,1]*ltar + 
   predhr$coeff[3,1]*highmod + predhr$coeff[4,1]*ltar*highmod
sllhr <- predhr$coeff[1,1] + predhr$coeff[2,1]*ltar + 
   predhr$coeff[3,1]*lowmod + predhr$coeff[4,1]*ltar*lowmod
sprep <- t(matrix(c(htar,shhhr,htar,shlhr,ltar,slhhr,ltar,sllhr),2,4))

plot(sprep[,1],sprep[,2],ann=FALSE, ylim=c(20,60),xlim=c(5,20))
segments(htar,shhhr,ltar,slhhr,lty="dashed")
segments(htar,shlhr,ltar,sllhr)
mtext("Respondent's Years of Education", side=1, line=2.5, cex=1)
mtext("Predicted Occupational Prestige", side=2, line=2.5, cex=1)
legend(6,55,c("14.2 Years (1 SD Above Mean)","7.3 Years (1 SD Below Mean)"),cex=.8, 
  lty=c("solid","dashed"), title="Mother's Years of Education")
```

### Both together
Also need to code up a way to use layout and display them both.

```{r}
#pdf("gssinteract.pdf", width = 8, height = 10 )
# op=par(mfrow=c(2,1))
# plot(sprep[,1],sprep[,2],ann=FALSE, ylim=c(30,60),xlim=c(8,18),pch=21)
# segments(htar,shhhr,ltar,slhhr)
# segments(htar,shlhr,ltar,sllhr,lty="dashed")
# mtext("Years of Education", side=1, line=2.5, cex=1)
# mtext("Predicted Occupational Prestige", side=2, line=2.5, cex=1)
# legend(7.7,60,c("14.2 Years (1 SD Above Mean)","7.3 Years (1 SD Below Mean)"),cex=.8, 
#   lty=c("solid","dashed"), title="Mother's Years of Education")
# plot(prep[,1],prep[,2],ann=FALSE, ylim=c(30,60),xlim=c(8,18),pch=24)
# segments(hthm,hhhr,lthm,lhhr)
# segments(htlm,hlhr,ltlm,llhr,lty="dashed")
# mtext("Years of Education", side=1, line=2.5, cex=1)
# mtext("Predicted Occupational Prestige", side=2, line=2.5, cex=1)
# legend(7.7,60,c("14.2 Years (1 SD Above Mean)","7.3 Years (1 SD Below Mean)"),cex=.8, 
#   lty=c("solid","dashed"), title="Mother's Years of Education")
# par(op)

# Bivariate Distribution of Target and Moderator

#pdf("gssbivariate.pdf", width = 8, height = 10)
plot(jitter(educ, factor=.4),jitter(maeduc,factor=.8),ann=FALSE,pch=20,cex=.6, col='grey60')
mtext("Years of Education", side=1, line=2.5, cex=1)
mtext("Mother's Years of Education", side=2, line=2.5, cex=1)
abline(v = ltar, lty="dashed")
abline(v = htar)
abline(h = lowmod, lty="dashed")
abline(h = highmod)
legend(0,20,c("1 SD Below Mean","1 SD Above Mean"),cex=.8, lty=c("dashed","solid"), title="Reference Lines")
points(hthm,highmod,pch=17)
points(htlm,lowmod,pch=17)
points(lthm,highmod,pch=17)
points(ltlm,lowmod,pch=17)
points(htar,highmod,pch=19)
points(htar,lowmod,pch=19)
points(ltar,highmod,pch=19)
points(ltar,lowmod,pch=19)
# points(hthm,highmod,pch=24)
# points(htlm,lowmod,pch=24)
# points(lthm,highmod,pch=24)
# points(ltlm,lowmod,pch=24)
# points(htar,highmod,pch=21)
# points(htar,lowmod,pch=21)
# points(ltar,highmod,pch=21)
# points(ltar,lowmod,pch=21)

#pdf("gssbivariate.pdf", width = 8, height = 10)
# plot(jitter(educ, factor=.4),jitter(maeduc,factor=.4),ann=FALSE,pch=20)
# mtext("Years of Education", side=1, line=2.5, cex=1)
# mtext("Mother's Years of Education", side=2, line=2.5, cex=1)
# abline(v = ltar, lty="dashed")
# abline(v = htar)
# abline(h = lowmod, lty="dashed")
# abline(h = highmod)
# legend(0,20,c("1 SD Below Mean","1 SD Above Mean"),cex=.8, lty=c("dashed","solid"), title="Reference Lines")
# points(hthm,highmod,pch=24)
# points(htlm,lowmod,pch=24)
# points(lthm,highmod,pch=24)
# points(ltlm,lowmod,pch=24)
# points(htar,highmod,pch=21)
# points(htar,lowmod,pch=21)
# points(ltar,highmod,pch=21)
# points(ltar,lowmod,pch=21)

```


